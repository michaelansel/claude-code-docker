#!/usr/bin/env bash
# Tests for claude-docker — exercises argument parsing, agent lookup, and
# command construction without actually running containers.
set -euo pipefail

PASS=0
FAIL=0
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
UNDER_TEST="$SCRIPT_DIR/claude-docker"

# --- helpers ---

setup() {
    TEST_DIR=$(mktemp -d)
    # Fake credentials so the script doesn't bail early
    mkdir -p "$TEST_DIR/.claude"
    echo '{}' > "$TEST_DIR/.claude/.credentials.json"
    mkdir -p "$TEST_DIR/.claude-docker"
    # Fake finch that logs the command it would run
    cat > "$TEST_DIR/finch" <<'STUB'
#!/usr/bin/env bash
if [[ "${1:-}" == "image" ]]; then exit 0; fi
echo "FINCH_ARGS: $*"
STUB
    chmod +x "$TEST_DIR/finch"
    # Fake format-stream
    cat > "$TEST_DIR/format-stream" <<'STUB'
#!/usr/bin/env bash
cat
STUB
    chmod +x "$TEST_DIR/format-stream"
    export PATH="$TEST_DIR:$PATH"
    export HOME="$TEST_DIR"
}

teardown() {
    rm -rf "$TEST_DIR"
}

assert_eq() {
    local label="$1" expected="$2" actual="$3"
    if [[ "$expected" == "$actual" ]]; then
        echo "  PASS: $label"
        PASS=$((PASS + 1))
    else
        echo "  FAIL: $label"
        echo "    expected: $expected"
        echo "    actual:   $actual"
        FAIL=$((FAIL + 1))
    fi
}

assert_contains() {
    local label="$1" needle="$2" haystack="$3"
    if [[ "$haystack" == *"$needle"* ]]; then
        echo "  PASS: $label"
        PASS=$((PASS + 1))
    else
        echo "  FAIL: $label"
        echo "    expected to contain: $needle"
        echo "    actual:              $haystack"
        FAIL=$((FAIL + 1))
    fi
}

assert_exit() {
    local label="$1" expected="$2" actual="$3"
    if [[ "$expected" -eq "$actual" ]]; then
        echo "  PASS: $label"
        PASS=$((PASS + 1))
    else
        echo "  FAIL: $label (exit $actual, expected $expected)"
        FAIL=$((FAIL + 1))
    fi
}

# --- tests ---

echo "=== agent list ==="
setup
out=$(bash "$UNDER_TEST" agent list 2>&1)
assert_contains "shows notes agent" "notes" "$out"
assert_contains "shows directory" "~/Documents/Notes" "$out"
teardown

echo "=== agent unknown ==="
setup
rc=0
out=$(bash "$UNDER_TEST" agent nonexistent 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "error message" "unknown agent" "$out"
assert_contains "lists available agents" "notes" "$out"
teardown

echo "=== agent with no name ==="
setup
rc=0
out=$(bash "$UNDER_TEST" agent 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "error message" "requires a name" "$out"
teardown

echo "=== no arguments shows usage ==="
setup
rc=0
out=$(bash "$UNDER_TEST" 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "shows usage" "Usage:" "$out"
teardown

echo "=== help flag ==="
setup
out=$(bash "$UNDER_TEST" -h 2>&1)
assert_contains "shows agent usage" "agent <name>" "$out"
assert_contains "shows --no-stream" "--no-stream" "$out"
teardown

echo "=== direct prompt passes through ==="
setup
out=$(bash "$UNDER_TEST" "hello world" 2>&1)
assert_contains "prompt in finch args" "hello world" "$out"
teardown

echo "=== direct prompt with -s streams ==="
setup
# Need format-stream in SCRIPT_DIR — symlink our stub
ln -sf "$TEST_DIR/format-stream" "$SCRIPT_DIR/format-stream.test-bak" 2>/dev/null || true
out=$(bash "$UNDER_TEST" -s "hello" 2>&1)
assert_contains "uses stream-json" "stream-json" "$out"
teardown

echo "=== agent mode sets /c3po auto ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" agent notes 2>&1)
assert_contains "prompt is /c3po auto" "/c3po auto" "$out"
teardown

echo "=== agent mode streams by default ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" agent notes 2>&1)
assert_contains "uses stream-json" "stream-json" "$out"
teardown

echo "=== agent mode --no-stream disables streaming ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" --no-stream agent notes 2>&1)
assert_contains "prompt is /c3po auto" "/c3po auto" "$out"
# Should NOT have stream-json since --no-stream was passed
if [[ "$out" != *"stream-json"* ]]; then
    echo "  PASS: no stream-json flag"
    PASS=$((PASS + 1))
else
    echo "  FAIL: stream-json should not be present with --no-stream"
    FAIL=$((FAIL + 1))
fi
teardown

echo "=== flags before agent subcommand ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" -sj agent notes 2>&1)
assert_contains "uses stream-json" "stream-json" "$out"
assert_contains "prompt is /c3po auto" "/c3po auto" "$out"
teardown

# --- cleanup stray test artifacts ---
rm -f "$SCRIPT_DIR/format-stream.test-bak"

# --- summary ---
echo ""
echo "Results: $PASS passed, $FAIL failed"
if [[ $FAIL -gt 0 ]]; then
    exit 1
fi
