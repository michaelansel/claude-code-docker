#!/usr/bin/env bash
# Tests for claude-docker — exercises argument parsing, agent lookup, and
# command construction without actually running containers.
set -euo pipefail

PASS=0
FAIL=0
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
UNDER_TEST="$SCRIPT_DIR/claude-docker"

# --- helpers ---

setup() {
    TEST_DIR=$(mktemp -d)
    # Fake credentials so the script doesn't bail early
    mkdir -p "$TEST_DIR/.claude"
    echo '{}' > "$TEST_DIR/.claude/.credentials.json"
    mkdir -p "$TEST_DIR/.claude-docker"
    # Copy agents.yaml into the fake config dir
    cp "$SCRIPT_DIR/agents.yaml.example" "$TEST_DIR/.claude-docker/agents.yaml"
    # Fake finch that logs the command it would run
    cat > "$TEST_DIR/finch" <<'STUB'
#!/usr/bin/env bash
if [[ "${1:-}" == "image" ]]; then exit 0; fi
if [[ "${1:-}" == "stop" ]]; then exit 0; fi
echo "FINCH_ARGS: $*"
STUB
    chmod +x "$TEST_DIR/finch"
    # Fake format-stream
    cat > "$TEST_DIR/format-stream" <<'STUB'
#!/usr/bin/env bash
cat
STUB
    chmod +x "$TEST_DIR/format-stream"
    export PATH="$TEST_DIR:$PATH"
    export HOME="$TEST_DIR"
}

teardown() {
    rm -rf "$TEST_DIR"
}

assert_eq() {
    local label="$1" expected="$2" actual="$3"
    if [[ "$expected" == "$actual" ]]; then
        echo "  PASS: $label"
        PASS=$((PASS + 1))
    else
        echo "  FAIL: $label"
        echo "    expected: $expected"
        echo "    actual:   $actual"
        FAIL=$((FAIL + 1))
    fi
}

assert_contains() {
    local label="$1" needle="$2" haystack="$3"
    if [[ "$haystack" == *"$needle"* ]]; then
        echo "  PASS: $label"
        PASS=$((PASS + 1))
    else
        echo "  FAIL: $label"
        echo "    expected to contain: $needle"
        echo "    actual:              $haystack"
        FAIL=$((FAIL + 1))
    fi
}

assert_not_contains() {
    local label="$1" needle="$2" haystack="$3"
    if [[ "$haystack" != *"$needle"* ]]; then
        echo "  PASS: $label"
        PASS=$((PASS + 1))
    else
        echo "  FAIL: $label"
        echo "    expected NOT to contain: $needle"
        echo "    actual:                  $haystack"
        FAIL=$((FAIL + 1))
    fi
}

assert_exit() {
    local label="$1" expected="$2" actual="$3"
    if [[ "$expected" -eq "$actual" ]]; then
        echo "  PASS: $label"
        PASS=$((PASS + 1))
    else
        echo "  FAIL: $label (exit $actual, expected $expected)"
        FAIL=$((FAIL + 1))
    fi
}

# --- tests ---

echo "=== agent list ==="
setup
out=$(bash "$UNDER_TEST" agent list 2>&1)
assert_contains "shows notes agent" "notes" "$out"
assert_contains "shows directory" "~/Documents/Notes" "$out"
teardown

echo "=== agent unknown ==="
setup
rc=0
out=$(bash "$UNDER_TEST" agent nonexistent 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "error message" "unknown agent" "$out"
assert_contains "lists available agents" "notes" "$out"
teardown

echo "=== agent with no name ==="
setup
rc=0
out=$(bash "$UNDER_TEST" agent 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "error message" "requires a name" "$out"
teardown

echo "=== no arguments shows usage ==="
setup
rc=0
out=$(bash "$UNDER_TEST" 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "shows usage" "Usage:" "$out"
teardown

echo "=== help flag ==="
setup
out=$(bash "$UNDER_TEST" -h 2>&1)
assert_contains "shows agent usage" "agent <name>" "$out"
assert_contains "shows --no-stream" "--no-stream" "$out"
teardown

echo "=== direct prompt passes through ==="
setup
out=$(bash "$UNDER_TEST" "hello world" 2>&1)
assert_contains "prompt in finch args" "hello world" "$out"
teardown

echo "=== direct prompt with -s streams ==="
setup
# Need format-stream in SCRIPT_DIR — symlink our stub
ln -sf "$TEST_DIR/format-stream" "$SCRIPT_DIR/format-stream.test-bak" 2>/dev/null || true
out=$(bash "$UNDER_TEST" -s "hello" 2>&1)
assert_contains "uses stream-json" "stream-json" "$out"
teardown

echo "=== agent mode sets /c3po auto ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" agent notes 2>&1)
assert_contains "prompt is /c3po auto" "/c3po auto" "$out"
teardown

echo "=== agent mode streams by default ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" agent notes 2>&1)
assert_contains "uses stream-json" "stream-json" "$out"
teardown

echo "=== agent mode --no-stream disables streaming ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" --no-stream agent notes 2>&1)
assert_contains "prompt is /c3po auto" "/c3po auto" "$out"
# Should NOT have stream-json since --no-stream was passed
if [[ "$out" != *"stream-json"* ]]; then
    echo "  PASS: no stream-json flag"
    PASS=$((PASS + 1))
else
    echo "  FAIL: stream-json should not be present with --no-stream"
    FAIL=$((FAIL + 1))
fi
teardown

echo "=== flags before agent subcommand ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" -sj agent notes 2>&1)
assert_contains "uses stream-json" "stream-json" "$out"
assert_contains "prompt is /c3po auto" "/c3po auto" "$out"
teardown

echo "=== container gets a --name ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" --no-stream agent notes 2>&1)
assert_contains "has --name flag" "--name claude-code-" "$out"
teardown

echo "=== agent mode sets CLAUDE_PROJECT_NAME to agent name ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
out=$(bash "$UNDER_TEST" --no-stream agent notes 2>&1)
assert_contains "env has CLAUDE_PROJECT_NAME=notes" "CLAUDE_PROJECT_NAME=notes" "$out"
teardown

echo "=== direct mode sets CLAUDE_PROJECT_NAME to dir basename ==="
setup
out=$(bash "$UNDER_TEST" -d /tmp "hello" 2>&1)
assert_contains "env has CLAUDE_PROJECT_NAME=tmp" "CLAUDE_PROJECT_NAME=tmp" "$out"
teardown

echo "=== token env var passes through ==="
setup
# Remove credentials file so we rely on env var
rm -f "$TEST_DIR/.claude/.credentials.json"
out=$(CLAUDE_CODE_OAUTH_TOKEN="test-token-123" bash "$UNDER_TEST" "hello" 2>&1)
assert_contains "env has CLAUDE_CODE_OAUTH_TOKEN" "CLAUDE_CODE_OAUTH_TOKEN=test-token-123" "$out"
assert_not_contains "no credentials mount" ".credentials.json:ro" "$out"
teardown

echo "=== token file is read ==="
setup
# Remove credentials file so we rely on token file
rm -f "$TEST_DIR/.claude/.credentials.json"
echo "file-token-456" > "$TEST_DIR/.claude-docker/.oauth-token"
out=$(bash "$UNDER_TEST" "hello" 2>&1)
assert_contains "env has CLAUDE_CODE_OAUTH_TOKEN from file" "CLAUDE_CODE_OAUTH_TOKEN=file-token-456" "$out"
assert_not_contains "no credentials mount" ".credentials.json:ro" "$out"
teardown

echo "=== credentials file fallback ==="
setup
# credentials file exists (from setup), no token
out=$(bash "$UNDER_TEST" "hello" 2>&1)
assert_contains "mounts credentials file" ".credentials.json:ro" "$out"
assert_not_contains "no CLAUDE_CODE_OAUTH_TOKEN" "CLAUDE_CODE_OAUTH_TOKEN" "$out"
teardown

echo "=== no auth shows error ==="
setup
rm -f "$TEST_DIR/.claude/.credentials.json"
rc=0
out=$(bash "$UNDER_TEST" "hello" 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "error mentions setup" "claude-docker setup" "$out"
teardown

echo "=== env var takes priority over token file ==="
setup
rm -f "$TEST_DIR/.claude/.credentials.json"
echo "file-token-456" > "$TEST_DIR/.claude-docker/.oauth-token"
out=$(CLAUDE_CODE_OAUTH_TOKEN="env-token-789" bash "$UNDER_TEST" "hello" 2>&1)
assert_contains "uses env var token" "CLAUDE_CODE_OAUTH_TOKEN=env-token-789" "$out"
assert_not_contains "does not use file token" "file-token-456" "$out"
teardown

echo "=== cleanup trap calls finch stop on signal ==="
setup
mkdir -p "$TEST_DIR/Documents/Notes"
# Replace finch stub with one that logs stop calls and handles signals like real finch
cat > "$TEST_DIR/finch" <<'STUB'
#!/usr/bin/env bash
if [[ "${1:-}" == "image" ]]; then exit 0; fi
if [[ "${1:-}" == "stop" ]]; then echo "STOP_CALLED: $2" >> "$HOME/finch-stop.log"; exit 0; fi
# Simulate a long-running container; exit on INT/TERM like real finch would
if [[ "${1:-}" == "run" ]]; then
    trap 'exit 130' INT TERM
    echo "FINCH_ARGS: $*"
    sleep 60 &
    wait
fi
STUB
chmod +x "$TEST_DIR/finch"
# Run claude-docker in background
bash "$UNDER_TEST" --no-stream agent notes > /dev/null 2>&1 &
TEST_PID=$!
sleep 0.5
# Send TERM to all descendants (finch stub first so it exits, then claude-docker's
# trap fires). pkill -P finds children of children recursively on macOS.
# We need the finch stub to exit first so bash can run its trap.
pkill -TERM -f "sleep 60" 2>/dev/null || true
sleep 1.5
if [[ -f "$TEST_DIR/finch-stop.log" ]]; then
    stop_log=$(cat "$TEST_DIR/finch-stop.log")
    assert_contains "finch stop called with container name" "claude-code-" "$stop_log"
else
    echo "  FAIL: finch stop was never called"
    FAIL=$((FAIL + 1))
fi
kill $TEST_PID 2>/dev/null || true
wait $TEST_PID 2>/dev/null || true
teardown

echo "=== .claude.json is auto-created when missing ==="
setup
# Remove any pre-existing .claude.json
rm -f "$TEST_DIR/.claude-docker/.claude.json"
out=$(bash "$UNDER_TEST" "hello" 2>&1)
assert_eq ".claude.json exists after run" "true" "$(test -f "$TEST_DIR/.claude-docker/.claude.json" && echo true || echo false)"
assert_eq ".claude.json contains empty object" "{}" "$(cat "$TEST_DIR/.claude-docker/.claude.json")"
assert_contains "mounts .claude.json" ".claude.json:/home/node/.claude.json" "$out"
teardown

echo "=== .claude.json is always mounted ==="
setup
echo '{"mcpServers":{}}' > "$TEST_DIR/.claude-docker/.claude.json"
out=$(bash "$UNDER_TEST" "hello" 2>&1)
assert_contains "mounts .claude.json" ".claude.json:/home/node/.claude.json" "$out"
teardown

echo "=== setup-c3po requires two arguments ==="
setup
rc=0
out=$(bash "$UNDER_TEST" setup-c3po 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "shows usage" "coordinator_url" "$out"
teardown

echo "=== setup-c3po with one argument fails ==="
setup
rc=0
out=$(bash "$UNDER_TEST" setup-c3po http://example.com 2>&1) || rc=$?
assert_exit "exits non-zero" 1 "$rc"
assert_contains "shows usage" "coordinator_url" "$out"
teardown

echo "=== shell subcommand runs interactive container ==="
setup
# Replace finch stub with one that just prints args and exits immediately
cat > "$TEST_DIR/finch" <<'STUB'
#!/usr/bin/env bash
if [[ "${1:-}" == "image" ]]; then exit 0; fi
if [[ "${1:-}" == "stop" ]]; then exit 0; fi
echo "FINCH_ARGS: $*"
exit 0
STUB
chmod +x "$TEST_DIR/finch"
out=$(echo "" | bash "$UNDER_TEST" shell 2>&1)
assert_contains "uses --entrypoint bash" "--entrypoint bash" "$out"
assert_contains "uses -it" "-it" "$out"
assert_contains "mounts .claude.json" ".claude.json:/home/node/.claude.json" "$out"
teardown

echo "=== help shows setup-c3po ==="
setup
out=$(bash "$UNDER_TEST" -h 2>&1)
assert_contains "shows setup-c3po" "setup-c3po" "$out"
assert_contains "shows shell" "shell" "$out"
teardown

# --- cleanup stray test artifacts ---
rm -f "$SCRIPT_DIR/format-stream.test-bak"

# --- summary ---
echo ""
echo "Results: $PASS passed, $FAIL failed"
if [[ $FAIL -gt 0 ]]; then
    exit 1
fi
