#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0" 2>/dev/null || realpath "$0")")" && pwd)"
IMAGE_NAME="claude-code"
CONFIG_DIR="$HOME/.claude-docker"
CREDENTIALS="$HOME/.claude/.credentials.json"
TOKEN_FILE="$CONFIG_DIR/.oauth-token"
USER_CONFIG="$CONFIG_DIR/.claude.json"
AGENTS_FILE="$CONFIG_DIR/agents.yaml"

build_hash() {
    cat "$SCRIPT_DIR/Dockerfile" "$SCRIPT_DIR/entrypoint.sh" | shasum -a 256 | cut -d' ' -f1
}

needs_rebuild() {
    if $BUILD; then return 0; fi
    if ! finch image inspect "$IMAGE_NAME" >/dev/null 2>&1; then return 0; fi
    local image_hash
    image_hash=$(finch image inspect "$IMAGE_NAME" --format '{{index .Config.Labels "build.hash"}}' 2>/dev/null) || true
    [[ "$image_hash" != "$(build_hash)" ]]
}

usage() {
    echo "Usage: claude-docker [options] <prompt>"
    echo "       claude-docker setup [token]    Set up authentication (provide token manually or extract from TUI)"
    echo "       claude-docker setup-c3po <url> <token>  Install and enroll c3po plugin"
    echo "       claude-docker shell            Interactive shell in container"
    echo "       claude-docker agent <name>     Run a named agent"
    echo "       claude-docker agent list       List available agents"
    echo ""
    echo "Options:"
    echo "  -d, --dir <path>   Working directory to mount (default: \$PWD)"
    echo "  -s, --stream       Stream formatted output (default)"
    echo "  -sj, --stream-json Stream raw JSON output"
    echo "  --no-stream        Disable streaming (streaming is on by default)"
    echo "  -b, --build        Rebuild the image before running"
    echo "  -h, --help         Show this help"
    echo ""
    echo "Examples:"
    echo "  claude-docker \"explain this project\""
    echo "  claude-docker -d ~/Code/myproject \"add tests for main.py\""
    echo "  claude-docker --build \"hello\""
    echo "  claude-docker agent list"
    echo "  claude-docker agent notes"
    echo "  claude-docker -b agent notes"
}

# Look up an agent directory from agents.yaml
# Uses grep/sed â€” no yq dependency needed
agent_lookup() {
    local name="$1"
    if [[ ! -f "$AGENTS_FILE" ]]; then
        echo "Error: agents.yaml not found at $AGENTS_FILE" >&2
        return 1
    fi
    local dir
    dir=$(sed -n "s/^${name}:[[:space:]]*//p" "$AGENTS_FILE" | head -1)
    if [[ -z "$dir" ]]; then
        return 1
    fi
    # Expand ~ to $HOME
    echo "${dir/#\~/$HOME}"
}

agent_list() {
    if [[ ! -f "$AGENTS_FILE" ]]; then
        echo "No agents.yaml found at $AGENTS_FILE" >&2
        exit 1
    fi
    echo "Available agents:"
    while IFS=: read -r name dir; do
        # Skip blank lines and comments
        [[ -z "$name" || "$name" =~ ^[[:space:]]*# ]] && continue
        # Trim whitespace
        dir="${dir#"${dir%%[![:space:]]*}"}"
        printf "  %-15s %s\n" "$name" "$dir"
    done < "$AGENTS_FILE"
}

WORK_DIR="$(pwd)"
BUILD=false
STREAM=true
STREAM_RAW=false
NO_STREAM=false
AGENT_MODE=false
AGENT_NAME=""
PROJECT_NAME=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        setup)
            mkdir -p "$CONFIG_DIR"
            shift
            # If token provided as argument, use it directly
            if [[ $# -gt 0 ]]; then
                TOKEN="$1"
                if [[ ! "$TOKEN" =~ ^sk-ant- && ! "$TOKEN" =~ ^sk-at- ]]; then
                    echo "Error: Token must start with 'sk-ant-' or 'sk-at-'" >&2
                    exit 1
                fi
                echo "$TOKEN" > "$TOKEN_FILE"
                chmod 600 "$TOKEN_FILE"
                echo "Token saved to $TOKEN_FILE" >&2
                exit 0
            fi

            # Otherwise try to extract from interactive claude setup-token
            echo "Running 'claude setup-token' to generate a long-lived token..." >&2
            echo "NOTE: Token extraction from TUI is fragile. For best results:" >&2
            echo "  1. Run: claude setup-token" >&2
            echo "  2. Copy the token manually" >&2
            echo "  3. Run: claude-docker setup <your-token>" >&2
            echo "" >&2
            RAW=$(claude setup-token) || { echo "Error: claude setup-token failed" >&2; exit 1; }
            TOKEN=$(python3 -c "
import re, sys
raw = sys.stdin.read()
# Strip ANSI escape codes but preserve whitespace to maintain token boundaries
clean = re.sub(r'\x1b\[[^a-zA-Z]*[a-zA-Z]', '', raw)
# Look for token followed by whitespace, punctuation, or end of string
# This prevents matching trailing UI text like 'Storethistokensecurely'
m = re.search(r'(sk-ant-[a-zA-Z0-9_-]+|sk-at-[a-zA-Z0-9_-]+)(?=\s|[.,!]|\$)', clean)
if not m:
    # Fallback: try without boundary check but limit length
    m = re.search(r'(sk-ant-[a-zA-Z0-9_-]{90,110}|sk-at-[a-zA-Z0-9_-]{90,110})', clean)
if m:
    print(m.group(1))
" <<< "$RAW")
            if [[ -z "$TOKEN" ]]; then
                echo "Error: Could not extract token from claude setup-token output." >&2
                echo "" >&2
                echo "Please provide the token manually:" >&2
                echo "  claude-docker setup <your-token>" >&2
                exit 1
            fi
            echo "$TOKEN" > "$TOKEN_FILE"
            chmod 600 "$TOKEN_FILE"
            echo "Token saved to $TOKEN_FILE" >&2
            exit 0
            ;;
        setup-c3po)
            shift
            if [[ $# -lt 2 ]]; then
                echo "Usage: claude-docker setup-c3po <coordinator_url> <admin_token>" >&2
                exit 1
            fi
            C3PO_URL="$1"
            C3PO_TOKEN="$2"
            shift 2

            mkdir -p "$CONFIG_DIR"
            [[ -f "$USER_CONFIG" ]] || echo '{}' > "$USER_CONFIG"

            # Build image if needed
            if needs_rebuild; then
                echo "Building $IMAGE_NAME image..." >&2
                finch build --label "build.hash=$(build_hash)" -t "$IMAGE_NAME" "$SCRIPT_DIR"
            fi

            echo "Installing and enrolling c3po plugin..." >&2
            finch run --rm -it \
                --entrypoint bash \
                -v "$CONFIG_DIR:/home/node/.claude" \
                -v "$USER_CONFIG:/home/node/.claude.json" \
                "$IMAGE_NAME" \
                -c "
                    set -euo pipefail
                    echo 'Adding/updating michaelansel marketplace...'
                    claude plugin marketplace update michaelansel 2>/dev/null \
                        || claude plugin marketplace add michaelansel/claude-code-plugins
                    echo 'Installing/updating c3po plugin...'
                    claude plugin update c3po@michaelansel 2>/dev/null \
                        || claude plugin install c3po@michaelansel
                    echo 'Enrolling with coordinator...'
                    SETUP_PY=\$(find ~/.claude/plugins -path '*/c3po*/setup.py' -print -quit)
                    if [[ -z \"\$SETUP_PY\" ]]; then
                        echo 'Error: Could not find c3po setup.py' >&2
                        exit 1
                    fi
                    python3 \"\$SETUP_PY\" --enroll '$C3PO_URL' '$C3PO_TOKEN' --machine docker --pattern 'docker/*'
                    echo 'Done! c3po plugin installed and enrolled.'
                "
            exit 0
            ;;
        shell)
            shift
            # Collect remaining args but don't require a prompt
            mkdir -p "$CONFIG_DIR"
            [[ -f "$USER_CONFIG" ]] || echo '{}' > "$USER_CONFIG"

            # Build image if needed
            if needs_rebuild; then
                echo "Building $IMAGE_NAME image..." >&2
                finch build --label "build.hash=$(build_hash)" -t "$IMAGE_NAME" "$SCRIPT_DIR"
            fi

            SHELL_MOUNTS=(
                -v "$CONFIG_DIR:/home/node/.claude"
                -v "$(pwd):/workspace"
                -v "$USER_CONFIG:/home/node/.claude.json"
            )

            # Mount credentials if available
            if [[ -f "$CREDENTIALS" ]]; then
                SHELL_MOUNTS+=(-v "$CREDENTIALS:/home/node/.claude/.credentials.json:ro")
            fi

            SHELL_ENV=()
            if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
                SHELL_ENV+=(-e "CLAUDE_CODE_OAUTH_TOKEN=$CLAUDE_CODE_OAUTH_TOKEN")
            elif [[ -f "$TOKEN_FILE" ]]; then
                SHELL_ENV+=(-e "CLAUDE_CODE_OAUTH_TOKEN=$(cat "$TOKEN_FILE")")
            fi

            finch run --rm -it \
                --entrypoint bash \
                ${SHELL_ENV[@]+"${SHELL_ENV[@]}"} \
                "${SHELL_MOUNTS[@]}" \
                "$IMAGE_NAME"
            exit 0
            ;;
        agent)
            AGENT_MODE=true
            shift
            if [[ $# -eq 0 ]]; then
                echo "Error: agent subcommand requires a name or 'list'" >&2
                echo "Usage: claude-docker agent <name|list>" >&2
                exit 1
            fi
            if [[ "$1" == "list" ]]; then
                agent_list
                exit 0
            fi
            AGENT_NAME="$1"
            shift
            ;;
        -d|--dir)
            WORK_DIR="$2"
            shift 2
            ;;
        -s|--stream)
            STREAM=true
            shift
            ;;
        -sj|--stream-json)
            STREAM_RAW=true
            shift
            ;;
        --no-stream)
            NO_STREAM=true
            STREAM=false
            shift
            ;;
        -b|--build)
            BUILD=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Agent mode: resolve directory and set defaults
if $AGENT_MODE; then
    AGENT_DIR=$(agent_lookup "$AGENT_NAME") || {
        echo "Error: unknown agent '$AGENT_NAME'" >&2
        echo "" >&2
        agent_list >&2
        exit 1
    }
    WORK_DIR="$AGENT_DIR"
    PROJECT_NAME="$AGENT_NAME"
fi

# Default project name to basename of the working directory
if [[ -z "$PROJECT_NAME" ]]; then
    PROJECT_NAME="$(basename "$WORK_DIR")"
fi

if ! $AGENT_MODE && [[ $# -eq 0 ]]; then
    usage
    exit 1
fi

HAS_CREDENTIALS_FILE=false
if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
    : # Token will be passed as env var below
elif [[ -f "$TOKEN_FILE" ]]; then
    CLAUDE_CODE_OAUTH_TOKEN=$(cat "$TOKEN_FILE")
    export CLAUDE_CODE_OAUTH_TOKEN
elif [[ -f "$CREDENTIALS" ]]; then
    HAS_CREDENTIALS_FILE=true
else
    echo "Error: No Claude Code authentication found." >&2
    echo "" >&2
    echo "Run setup to generate and store a token:" >&2
    echo "  claude-docker setup" >&2
    echo "" >&2
    echo "Or set CLAUDE_CODE_OAUTH_TOKEN environment variable manually." >&2
    exit 1
fi

mkdir -p "$CONFIG_DIR"

if needs_rebuild; then
    echo "Building $IMAGE_NAME image..." >&2
    finch build --label "build.hash=$(build_hash)" -t "$IMAGE_NAME" "$SCRIPT_DIR"
fi

MOUNTS=(
    -v "$CONFIG_DIR:/home/node/.claude"
    -v "$WORK_DIR:/workspace"
)
if $HAS_CREDENTIALS_FILE; then
    MOUNTS+=(-v "$CREDENTIALS:/home/node/.claude/.credentials.json:ro")
fi

# Ensure user-level config (.claude.json) exists so MCP config persists
[[ -f "$USER_CONFIG" ]] || echo '{}' > "$USER_CONFIG"
MOUNTS+=(-v "$USER_CONFIG:/home/node/.claude.json")

if $AGENT_MODE; then
    PROMPT="/c3po auto"
else
    PROMPT="$*"
fi

CLAUDE_ARGS=(-p "$PROMPT")
if $STREAM || $STREAM_RAW; then
    CLAUDE_ARGS=(--output-format stream-json --verbose -p "$PROMPT")
fi

ENV_ARGS=(-e "CLAUDE_PROJECT_NAME=$PROJECT_NAME")
if $AGENT_MODE; then
    ENV_ARGS+=(-e "CLAUDE_AGENT_MODE=1")
fi
if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
    ENV_ARGS+=(-e "CLAUDE_CODE_OAUTH_TOKEN=$CLAUDE_CODE_OAUTH_TOKEN")
fi
if [[ -n "${C3PO_DEBUG:-}" ]]; then
    ENV_ARGS+=(-e "C3PO_DEBUG=$C3PO_DEBUG")
fi

# Give the container a name so we can stop it on interrupt.
# finch run --rm doesn't stop the container when the host process is killed,
# so we trap INT/TERM and explicitly run `finch stop` to give the container
# a chance to shut down gracefully (important for c3po session hooks).
CONTAINER_NAME="claude-code-$$"

cleanup() {
    finch stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
}
trap cleanup EXIT

if $STREAM; then
    finch run --rm --name "$CONTAINER_NAME" "${ENV_ARGS[@]}" "${MOUNTS[@]}" "$IMAGE_NAME" "${CLAUDE_ARGS[@]}" | "$SCRIPT_DIR/format-stream"
    exit "${PIPESTATUS[0]}"
else
    finch run --rm --name "$CONTAINER_NAME" "${ENV_ARGS[@]}" "${MOUNTS[@]}" "$IMAGE_NAME" "${CLAUDE_ARGS[@]}"
fi
