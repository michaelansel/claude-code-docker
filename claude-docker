#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0" 2>/dev/null || realpath "$0")")" && pwd)"
IMAGE_NAME="claude-code"
CONFIG_DIR="$HOME/.claude-docker"
CREDENTIALS="$HOME/.claude/.credentials.json"
TOKEN_FILE="$CONFIG_DIR/.oauth-token"
USER_CONFIG="$CONFIG_DIR/.claude.json"
AGENTS_FILE="$CONFIG_DIR/agents.yaml"

usage() {
    echo "Usage: claude-docker [options] <prompt>"
    echo "       claude-docker setup            Set up authentication token"
    echo "       claude-docker agent <name>     Run a named agent"
    echo "       claude-docker agent list       List available agents"
    echo ""
    echo "Options:"
    echo "  -d, --dir <path>   Working directory to mount (default: \$PWD)"
    echo "  -s, --stream       Stream formatted output (default: buffer until done)"
    echo "  -sj, --stream-json Stream raw JSON output"
    echo "  --no-stream        Disable streaming (for agent mode, which streams by default)"
    echo "  -b, --build        Rebuild the image before running"
    echo "  -h, --help         Show this help"
    echo ""
    echo "Examples:"
    echo "  claude-docker \"explain this project\""
    echo "  claude-docker -d ~/Code/myproject \"add tests for main.py\""
    echo "  claude-docker --build \"hello\""
    echo "  claude-docker agent list"
    echo "  claude-docker agent notes"
    echo "  claude-docker -b agent notes"
}

# Look up an agent directory from agents.yaml
# Uses grep/sed â€” no yq dependency needed
agent_lookup() {
    local name="$1"
    if [[ ! -f "$AGENTS_FILE" ]]; then
        echo "Error: agents.yaml not found at $AGENTS_FILE" >&2
        return 1
    fi
    local dir
    dir=$(sed -n "s/^${name}:[[:space:]]*//p" "$AGENTS_FILE" | head -1)
    if [[ -z "$dir" ]]; then
        return 1
    fi
    # Expand ~ to $HOME
    echo "${dir/#\~/$HOME}"
}

agent_list() {
    if [[ ! -f "$AGENTS_FILE" ]]; then
        echo "No agents.yaml found at $AGENTS_FILE" >&2
        exit 1
    fi
    echo "Available agents:"
    while IFS=: read -r name dir; do
        # Skip blank lines and comments
        [[ -z "$name" || "$name" =~ ^[[:space:]]*# ]] && continue
        # Trim whitespace
        dir="${dir#"${dir%%[![:space:]]*}"}"
        printf "  %-15s %s\n" "$name" "$dir"
    done < "$AGENTS_FILE"
}

WORK_DIR="$(pwd)"
BUILD=false
STREAM=false
STREAM_RAW=false
NO_STREAM=false
AGENT_MODE=false
AGENT_NAME=""
PROJECT_NAME=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        setup)
            mkdir -p "$CONFIG_DIR"
            echo "Running 'claude setup-token' to generate a long-lived token..." >&2
            RAW=$(claude setup-token) || { echo "Error: claude setup-token failed" >&2; exit 1; }
            # claude setup-token outputs a TUI with ANSI escapes embedded in the
            # token text itself, so we must strip them and remove whitespace before
            # extracting the token.
            TOKEN=$(python3 -c "
import re, sys
raw = sys.stdin.read()
clean = re.sub(r'\x1b\[[^a-zA-Z]*[a-zA-Z]', '', raw)
clean = clean.replace(' ', '').replace('\n', '').replace('\r', '')
m = re.search(r'sk-ant-[a-zA-Z0-9_-]+|sk-at-[a-zA-Z0-9_-]+', clean)
if m:
    print(m.group(0))
" <<< "$RAW")
            if [[ -z "$TOKEN" ]]; then
                echo "Error: Could not extract token from claude setup-token output." >&2
                echo "You can set CLAUDE_CODE_OAUTH_TOKEN manually instead." >&2
                exit 1
            fi
            echo "$TOKEN" > "$TOKEN_FILE"
            chmod 600 "$TOKEN_FILE"
            echo "Token saved to $TOKEN_FILE" >&2
            exit 0
            ;;
        agent)
            AGENT_MODE=true
            shift
            if [[ $# -eq 0 ]]; then
                echo "Error: agent subcommand requires a name or 'list'" >&2
                echo "Usage: claude-docker agent <name|list>" >&2
                exit 1
            fi
            if [[ "$1" == "list" ]]; then
                agent_list
                exit 0
            fi
            AGENT_NAME="$1"
            shift
            ;;
        -d|--dir)
            WORK_DIR="$2"
            shift 2
            ;;
        -s|--stream)
            STREAM=true
            shift
            ;;
        -sj|--stream-json)
            STREAM_RAW=true
            shift
            ;;
        --no-stream)
            NO_STREAM=true
            shift
            ;;
        -b|--build)
            BUILD=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Agent mode: resolve directory and set defaults
if $AGENT_MODE; then
    AGENT_DIR=$(agent_lookup "$AGENT_NAME") || {
        echo "Error: unknown agent '$AGENT_NAME'" >&2
        echo "" >&2
        agent_list >&2
        exit 1
    }
    WORK_DIR="$AGENT_DIR"
    PROJECT_NAME="$AGENT_NAME"
    # Agent mode streams by default unless --no-stream is passed
    if ! $NO_STREAM && ! $STREAM_RAW; then
        STREAM=true
    fi
fi

# Default project name to basename of the working directory
if [[ -z "$PROJECT_NAME" ]]; then
    PROJECT_NAME="$(basename "$WORK_DIR")"
fi

if ! $AGENT_MODE && [[ $# -eq 0 ]]; then
    usage
    exit 1
fi

HAS_CREDENTIALS_FILE=false
if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
    : # Token will be passed as env var below
elif [[ -f "$TOKEN_FILE" ]]; then
    CLAUDE_CODE_OAUTH_TOKEN=$(cat "$TOKEN_FILE")
    export CLAUDE_CODE_OAUTH_TOKEN
elif [[ -f "$CREDENTIALS" ]]; then
    HAS_CREDENTIALS_FILE=true
else
    echo "Error: No Claude Code authentication found." >&2
    echo "" >&2
    echo "Run setup to generate and store a token:" >&2
    echo "  claude-docker setup" >&2
    echo "" >&2
    echo "Or set CLAUDE_CODE_OAUTH_TOKEN environment variable manually." >&2
    exit 1
fi

mkdir -p "$CONFIG_DIR"

if $BUILD || ! finch image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
    echo "Building $IMAGE_NAME image..." >&2
    finch build -t "$IMAGE_NAME" "$SCRIPT_DIR"
fi

MOUNTS=(
    -v "$CONFIG_DIR:/home/node/.claude"
    -v "$WORK_DIR:/workspace"
)
if $HAS_CREDENTIALS_FILE; then
    MOUNTS+=(-v "$CREDENTIALS:/home/node/.claude/.credentials.json:ro")
fi

# Mount user-level config (.claude.json) if it exists (for MCP servers, etc.)
if [[ -f "$USER_CONFIG" ]]; then
    MOUNTS+=(-v "$USER_CONFIG:/home/node/.claude.json")
fi

if $AGENT_MODE; then
    PROMPT="/c3po auto"
else
    PROMPT="$*"
fi

CLAUDE_ARGS=(-p "$PROMPT")
if $STREAM || $STREAM_RAW; then
    CLAUDE_ARGS=(--output-format stream-json --verbose -p "$PROMPT")
fi

ENV_ARGS=(-e "CLAUDE_PROJECT_NAME=$PROJECT_NAME")
if [[ -n "${CLAUDE_CODE_OAUTH_TOKEN:-}" ]]; then
    ENV_ARGS+=(-e "CLAUDE_CODE_OAUTH_TOKEN=$CLAUDE_CODE_OAUTH_TOKEN")
fi

# Give the container a name so we can stop it on interrupt.
# finch run --rm doesn't stop the container when the host process is killed,
# so we trap INT/TERM and explicitly run `finch stop` to give the container
# a chance to shut down gracefully (important for c3po session hooks).
CONTAINER_NAME="claude-code-$$"

cleanup() {
    finch stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
}
trap cleanup EXIT

if $STREAM; then
    finch run --rm --name "$CONTAINER_NAME" "${ENV_ARGS[@]}" "${MOUNTS[@]}" "$IMAGE_NAME" "${CLAUDE_ARGS[@]}" | "$SCRIPT_DIR/format-stream"
    exit "${PIPESTATUS[0]}"
else
    finch run --rm --name "$CONTAINER_NAME" "${ENV_ARGS[@]}" "${MOUNTS[@]}" "$IMAGE_NAME" "${CLAUDE_ARGS[@]}"
fi
